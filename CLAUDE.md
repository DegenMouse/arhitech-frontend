# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
Romanian architectural document management system for construction permit workflows. Built with Nuxt 3, MySQL, and MinIO for managing pre/post construction permit documentation (`anteCU`/`postCU` phases).

## Commands
- **Development**: `npm run dev` - Start development server on http://localhost:3000
- **Build**: `npm run build` - Build for production
- **Preview**: `npm run preview` - Preview production build
- **Lint**: `npm run lint` - Run ESLint
- **Test**: `npm run test` - Run tests with Vitest
- **Test Watch**: `npm run test:watch` - Run tests in watch mode

## Tech Stack
- **Frontend**: Nuxt 3 (SSR disabled), Vue 3 Composition API, TailwindCSS
- **Backend**: MySQL 8.0 with JSON:API compliant REST API
- **Storage**: MinIO object storage for PDF files
- **Auth**: JWT tokens with localStorage persistence
- **Testing**: Vitest with jsdom

## Database Schema (Key Tables)
```
users → users_in_company → companies
       ↘ users_in_project → projects → projDocs → docTypes
                                  ↘ localitate, phases
```

**Core Entities:**
- `users`: Base accounts (one company per user)
- `companies`: Organizations with multiple members/admins
- `projects`: Company projects with phase (`anteCU`/`postCU`) and location
- `docTypes`: Document templates (input/output, location-specific) - **NO filePath field**, path = `{localitateId||'general'}/{docTypeId}`
- `projDocs`: Document instances with states: `missing` → `progress` → `filled` → `pending` → `finished` - **NO filePath field**, path = `{companyId}/projects/{projectId}/{projDocId}`

## API Structure
**Base URL**: `https://dbapi01.softaccel.net/apis/arhiTech`

**Format**: JSON:API compliant
```json
{
  "data": {"id": "...", "type": "...", "attributes": {...}, "relationships": {...}},
  "includes": [...],
  "jsonapi": "1.0"
}
```

**Important**: 
- **GET responses**: Foreign keys in `relationships`, related data in `includes` array via `?include=`
- **POST/PATCH requests**: ALL fields (including foreign keys) go in `attributes`

**Key Endpoints:**
- `POST /auth/login/` → `{"jwt": "..."}`
- `GET /data/users/{id}` → User profile
- `GET /data/projects/{id}/projDocs/?include=docType_id` → Project documents
- `PATCH /data/projDocs/{id}` → Update document state

## MinIO Storage Structure
```
minio/
├─ cmpfiles/{companyId}/projects/{projectId}/{projDocId}  # PDF files (projDocId = projDocs.id)
└─ templates/{localitateId||'general'}/{docTypeId}       # Templates (docTypeId = docTypes.id)
```

**File Path Logic**: **NO filePath fields in DB** - all paths determined by record IDs:
- Templates: `{localitateId||'general'}/{docTypeId}`  
- Project docs: `{companyId}/projects/{projectId}/{projDocId}`

## Application Architecture

### Core Structure
- **SSR disabled** (`ssr: false` in nuxt.config.ts) - SPA mode
- **Global middleware**: Authentication and company role enforcement
- **Modal system**: Centralized error/success/confirm modals in app.vue
- **Composables**: State management and API interactions

### Key Composables
- `useUser()` - Authentication state and user data
- `useUI()` - Global error/success messaging
- `useConfirm()` - Confirmation dialogs
- `fetchUserData()` - User profile and company data loading
- `fetchCompany()` - Company-specific data fetching

### Middleware System
- `loggedIn.global.js` - Protects all routes except `/` and `/login`
- `company.global.js` - Role-based redirects (admin/member dashboards)
- Dev routes (`/dev/*`) bypass authentication

### Server API Routes
- `minio-put.js` - Generate presigned PUT URLs (5min validity, auto-adds .pdf extension)
- `minio-get.js` - Generate presigned GET URLs for file downloads
- `minio-del.js` - Generate presigned DELETE URLs for file removal
- `doc2pdf.js` - Convert DOCX/images to PDF using LibreOffice

### PDF Integration
- PDF.js integrated in `/public/pdfjs/` for in-browser viewing
- `pdf-lib` for PDF manipulation
- `libreoffice-convert` for DOCX → PDF conversion
- All files stored as PDF in MinIO for consistency

## Application Flow
1. **Auth**: Login → JWT stored in localStorage
2. **Company**: One user per company, multiple admins possible  
3. **Projects**: Location-specific document requirements
4. **Documents**: Auto-generated by DB triggers, PDF conversion pipeline
5. **Workflow**: Upload → Convert to PDF → Store in MinIO → Update state

## Key Features
- Role-based access (admin/member)
- Document state management with workflow
- Location-specific compliance (Romanian municipalities)
- PDF conversion (DOCX/images → PDF)
- MinIO presigned URLs (5min validity)

## Authentication Flow
1. Login → JWT stored in localStorage
2. Global middleware checks auth on route changes
3. User data re-evaluation when `reEvalRequired` flag set
4. Company membership determines dashboard access (admin/member)

## Role-Based Access
- **Company Admin**: Can manage projects, members, and documents
- **Company Member**: Can view assigned projects and upload documents
- **No Company**: Redirected to `/noComp` for company creation/joining

## Document Workflow
1. Projects auto-generate required documents via DB triggers
2. Documents progress through states: `missing` → `progress` → `filled` → `pending` → `finished`
3. File uploads: Client → Presigned URL → MinIO → PDF conversion → State update
4. Location-specific compliance based on Romanian municipalities

## Current Branch Status
- **Main Branch**: `master`
- **Current Branch**: `infrastructure`

## Development Notes
- All files converted to PDF for storage
- Smart DB triggers auto-create required documents
- Company isolation enforced at MinIO path level
- Test endpoints available at `/dev` pages (bypass auth)
- All uploaded files converted to PDF for storage consistency