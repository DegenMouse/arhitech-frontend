# ProjectDocuments Component Documentation

## Overview

The `ProjectDocuments.vue` component is a comprehensive document management interface for Romanian architectural permit workflows. It handles the display, upload, and state management of construction permit documents (`anteCU`/`postCU` phases) with support for related document packages and workflow automation.

## Document States

Documents progress through a defined lifecycle with the following states:

### State Definitions

| State | Description | Actions Available | UI Indicator |
|-------|-------------|-------------------|-------------|
| `missing` | Document has not been uploaded yet | Upload | Red/Orange badge |
| `needed` | Document is required for the workflow | Upload | Yellow badge |
| `progress` | Document uploaded but awaiting processing/confirmation | Re-upload, Finish | Yellow badge |
| `pending` | Document under review or awaiting approval | View | Blue badge |
| `filled` | Document completed and processed | View | Green badge |
| `finished` | Document fully confirmed and workflow complete | View | Green badge |

### State Transitions

```
missing → [Upload] → progress → [Finish] → finished
needed → [Upload] → progress → [Finish] → finished
progress → [Re-upload] → progress
progress → [Finish] → finished
```

## Document Types

### Input Documents (isInput = 1)
- **Purpose**: Documents that users must upload
- **Actions**: Upload, Re-upload
- **Examples**: Architectural plans, permits, certificates
- **Storage**: User uploads converted to PDF and stored in MinIO

### Output Documents (isInput = 0)
- **Purpose**: Documents generated by the system
- **Actions**: View, Generate (via template)
- **Examples**: Generated reports, official forms
- **Storage**: System-generated PDFs in MinIO

## Document Relationships

### Adjacent Documents (doc_packages)

The system supports hierarchical document relationships through the `doc_packages` table:

```sql
doc_packages {
  id: number
  main: number      // docType_id of the main document
  adjacent: number  // docType_id of the related document
}
```

### Main Documents
Documents that have other documents related to them:
- Display progress bars showing completion of all related documents
- Clickable to open modal showing all related documents
- Progress calculation: (completed documents) / (total documents) * 100

### Related Documents
Documents that belong to a main document package:
- Displayed in the adjacent documents modal
- Contribute to the main document's completion percentage

## Component Architecture

### Key Composables
- `useUser()` - Authentication and user state
- `useUI()` - Global error/success messaging
- `useConfirm()` - Confirmation dialogs

### Reactive State
```javascript
// Document data
const docs = ref([])              // All project documents
const docPackages = ref([])       // Document relationships
const tags = ref([])              // Document tags for filtering

// UI state
const loading = ref(true)         // Loading indicator
const selectedTag = ref(null)     // Current filter tag

// Modal states
const adjacentModal = reactive({
  show: false,
  document: null,      // Currently selected document
  adjacentDocs: []     // Related documents
})

const uploadModal = reactive({
  show: false,
  docId: null
})
```

### Computed Properties

#### documents
Main computed property that:
1. Filters documents by state and tag
2. Excludes 'needed' state documents when showing all
3. Calculates completion data for documents with adjacent relationships
4. Returns array with `hasAdjacent`, `completedCount`, `totalCount`, `completionPercentage`

## UI Components

### Document Grid
- **Layout**: Responsive grid (1-3 columns based on screen size)
- **Card Structure**: Document name, status badge, progress bar (if applicable), action buttons
- **Interactions**: Click to open adjacent docs modal (if available)

### Progress Bars
Displayed for documents with adjacent relationships:
- **Progress Text**: "X/Y Documente necesare"
- **Visual Bar**: Blue (incomplete) or Green (100% complete)
- **Percentage**: Rounded percentage display

### Action Buttons

#### Upload Button
- **Condition**: `(state === 'missing' || state === 'needed') && isInput === '1'`
- **Action**: Opens upload modal
- **Style**: Blue background (#0c47b0)

#### Re-upload Button  
- **Condition**: `state === 'progress' && isInput === '1'`
- **Action**: Opens upload modal for file replacement
- **Style**: Yellow background

#### View Button
- **Condition**: `isInput === '0'` (output documents)
- **Action**: Opens document viewer
- **Style**: Gray background

### Adjacent Documents Modal

#### Structure
- **Header**: Main document name and completion summary
- **Main Section**: Primary document details and actions
- **Adjacent Section**: List of related documents with individual actions
- **Footer**: Additional information (destination links, undefined document warnings)

#### Features
- Scrollable content for long document lists
- Individual state management for each document
- Bulk completion tracking
- External link integration for document destinations

## API Integration

### Endpoints Used

#### Document Management
```javascript
// Fetch project documents
GET /data/projects/{id}/projDocs/?include=docType_id

// Update document state  
PATCH /data/projDocs/{id}
```

#### File Operations (Server API Routes)
```javascript
// Generate presigned upload URLs
POST /api/minio-put
// Generate presigned download URLs  
POST /api/minio-get
// Delete files
POST /api/minio-del
```

#### Document Relationships
```javascript
// Fetch document packages
GET /data/doc_packages
```

### Data Flow

1. **Initial Load**: Fetch documents, doc_packages, and tags
2. **Filter Application**: Apply tag filters and state exclusions
3. **Completion Calculation**: Calculate progress for documents with adjacent relationships
4. **User Interaction**: Handle uploads, state changes, modal operations
5. **State Updates**: Update local state and sync with backend

## File Upload Workflow

### Process
1. User clicks Upload button
2. Upload modal opens with file selection
3. File validation (PDF, DOCX, images)
4. Generate presigned URL from server
5. Upload file directly to MinIO
6. Convert non-PDF files to PDF (server-side)
7. Update document state to 'progress'
8. User can then 'Finish' to mark as complete

### Supported File Types
- **PDF**: Direct storage
- **DOCX**: Converted to PDF via LibreOffice
- **Images**: Converted to PDF
- **Size Limit**: Configurable (typically 10MB)

## State Management

### Local State Updates
```javascript
// Update document state
const updateDocumentState = async (docId, newState) => {
  // Update backend
  await updateProjDocState(docId, newState)
  
  // Update local state
  const docIndex = docs.value.findIndex(d => d.id === docId)
  if (docIndex !== -1) {
    docs.value[docIndex].state = newState
  }
}
```

### Completion Tracking
Progress bars automatically recalculate when:
- Document states change
- New documents are added
- Related documents are updated

## Error Handling

### Upload Errors
- File size validation
- File type validation
- Network error handling
- Presigned URL expiration

### State Change Errors
- Backend validation failures
- Network connectivity issues
- Permission errors

### UI Error States
- Loading states during operations
- Error messages via `useUI()` composable
- Retry mechanisms for failed operations

## Accessibility

### Keyboard Navigation
- Tab navigation through actionable elements
- Enter/Space activation for buttons
- Escape to close modals

### Screen Reader Support
- Semantic HTML structure
- ARIA labels for complex interactions
- Progress bar accessibility

### Visual Indicators
- Color-coded state badges
- Progress visualization
- Loading states

## Performance Considerations

### Optimization Strategies
- Computed properties for reactive calculations
- Event delegation for large document lists
- Lazy loading for modal content
- Debounced search/filter operations

### Memory Management
- Proper cleanup of event listeners
- Modal state reset on close
- File upload cleanup on errors

## Security

### File Upload Security
- Server-side validation
- Presigned URL limitations (5-minute expiry)
- File type restrictions
- Size limitations

### Data Access
- Company-level data isolation
- Role-based access controls
- JWT token validation

## Testing Considerations

### Unit Tests
- State transitions
- Computation logic
- Error handling

### Integration Tests
- File upload workflow
- Modal interactions
- API integration

### E2E Tests
- Complete document workflows
- Cross-browser compatibility
- Responsive design validation

## Troubleshooting

### Common Issues

#### Documents Not Loading
1. Check authentication status
2. Verify project access permissions
3. Check API endpoint availability
4. Review network connectivity

#### Upload Failures
1. Verify file size limits
2. Check file type restrictions
3. Confirm MinIO connectivity
4. Review presigned URL expiry

#### State Not Updating
1. Check backend API responses
2. Verify local state synchronization
3. Review error handling
4. Check user permissions

#### Progress Bar Issues
1. Verify doc_packages data loading
2. Check completion calculation logic
3. Review adjacent document relationships
4. Confirm state change propagation

## Future Enhancements

### Planned Features
- Bulk document operations
- Advanced filtering options
- Document versioning
- Automated workflow triggers
- Email notifications
- Audit trail logging

### Performance Improvements
- Virtual scrolling for large document sets
- Background state synchronization
- Optimistic UI updates
- Caching strategies